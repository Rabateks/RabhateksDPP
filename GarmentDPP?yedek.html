<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rabateks DPP ‚Äî Garment Manufacturing</title>
  <meta name="description" content="Digital Product Passport ‚Ä¢ Production Tracking ‚Ä¢ Quality Control">
  <style>
:root{
  --bg:#ffffff;
  --primary:#02154e;
  --accent:#f9ba00;
  --green:#005530;
  --red:#D51635;
  --navy:#02154e;
  --light:#f8f9fa;
  --muted:#6c757d;
  --border:#e9ecef;
  --shadow:rgba(0,0,0,0.1);
}
*{margin:0;padding:0;box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#1b2430}
.back-link{
  position:fixed;top:20px;right:20px;z-index:1000;
  background:var(--green);color:white;padding:12px 20px;border-radius:8px;
  text-decoration:none;font-weight:600;box-shadow:0 4px 12px rgba(0,85,48,0.25);
  transition:all 0.3s ease;border:none;cursor:pointer;
}
.back-link:hover{ transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,85,48,0.35); }
.back-link:active{ transform:translateY(0); }
.header{background:var(--bg);padding:25px 0;border-bottom:2px solid var(--border);text-align:center}
.header h1{color:var(--primary);font-size:28px;font-weight:700;margin-bottom:8px}
.header .subtitle{color:var(--muted);font-size:16px}
.container{max-width:1200px;margin:18px auto;padding:0 18px}
.field{margin-bottom:16px}
.field label{display:block;margin-bottom:6px;font-weight:500;color:#374151}
.field input,.field select,.field textarea{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-size:14px;transition:border-color 0.2s}
.field input:focus,.field select:focus,.field textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(2,21,78,0.1)}
input[readonly]{background:#f7f9fb;color:#4b5563;border-style:dashed}
.btn{padding:10px 18px;border:1px solid var(--border);border-radius:8px;background:var(--bg);cursor:pointer;font-weight:500;transition:all 0.2s;text-decoration:none;display:inline-block;font-size:14px}
.btn.primary{background:var(--primary);color:white;border-color:var(--primary)}
.btn.primary:hover{background:#1a237e;box-shadow:0 4px 12px rgba(2,21,78,0.25)}
.btn.danger{background:var(--red);color:white;border-color:var(--red)}
.btn.danger:hover{background:#b01429;box-shadow:0 4px 12px rgba(213,22,53,0.3)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:24px}
.dashboard{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:32px}
.dashboard .metric{background:var(--bg);padding:20px;border-radius:12px;text-align:center;border:1px solid var(--border);box-shadow:0 2px 8px var(--shadow)}
.dashboard .metric-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.dashboard .metric-value{font-size:24px;font-weight:700;color:var(--primary)}
.form-section{background:var(--bg);padding:24px;border-radius:12px;border:1px solid var(--border);box-shadow:0 2px 8px var(--shadow);margin-bottom:24px}
.form-section h3{margin-bottom:18px;color:var(--primary);font-size:18px}
.actions{display:flex;gap:12px;margin-top:20px;flex-wrap:wrap}
.table-container{background:var(--bg);border-radius:12px;overflow:hidden;border:1px solid var(--border);box-shadow:0 2px 8px var(--shadow)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:14px 16px;text-align:left;border-bottom:1px solid var(--border)}
.table th{background:#f8fafc;font-weight:600;color:#374151;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}
.table tr:hover{background:#f8fafc}
.tag{display:inline-block;padding:4px 10px;border-radius:16px;font-size:11px;font-weight:500;text-transform:uppercase;letter-spacing:0.5px}
.tag.active{background:#dcfce7;color:#166534}
.tag.processing{background:#fef3c7;color:#d97706}
.popup{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
.popup-content{background:var(--bg);border-radius:16px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 40px rgba(0,0,0,0.3)}
.popup-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.popup-body{padding:24px}
.popup-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted)}
.multi-select-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--border); border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 200px; overflow-y: auto; display: none; margin-top: 2px; }
.multi-select-option { padding: 10px 12px; cursor: pointer; transition: background 0.2s; }
.multi-select-option:hover { background: #f3f4f6; }
.multi-select-option.selected { background: var(--primary); color: white; }
.helper{font-size:12px;color:var(--muted);margin-top:4px;font-style:italic}
@media (max-width:1200px){.dashboard{grid-template-columns:repeat(3,1fr)}}
@media (max-width:1000px){.dashboard{grid-template-columns:repeat(2,1fr)}.grid{grid-template-columns:repeat(2,1fr)}}
@media (max-width:640px){.dashboard{grid-template-columns:1fr}.grid{grid-template-columns:1fr}.actions{flex-direction:column}}
.generator-section{margin:20px 0;padding:20px;background:#f0f8f0;border-radius:12px;border:2px solid #005530}
.generator-section h3{color:#005530;margin-bottom:15px;font-size:18px}
.generator-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:15px}
.generator-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <a class="back-link" href="index.optimized.html" title="Back to Main Dashboard">‚Üê Back to Main Dashboard</a>

  <div class="header">
    <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:12px">
      <div style="width:48px;height:48px;background:var(--green);border-radius:50%;display:flex;align-items:center;justify-content:center">
        <span style="color:white;font-weight:bold;font-size:16px">R</span>
      </div>
      <div>
        <h1><span style="color:#005530;">Rabateks</span> <span style="color:#f9ba00;">DPP</span> ‚Äî Garment Manufacturing</h1>
        <p class="subtitle">Digital Product Passport ‚Ä¢ Production Tracking ‚Ä¢ Quality Control</p>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Dashboard Metrics -->
    <div class="dashboard">
      <div class="metric">
        <div class="metric-label">üìã Total POs</div>
        <div class="metric-value" id="mPOs">0</div>
      </div>
      <div class="metric">
        <div class="metric-label">üëï Total Quantity</div>
        <div class="metric-value" id="mQty">0</div>
      </div>
      <div class="metric">
        <div class="metric-label">‚öñÔ∏è Avg Fabric Weight (gsm)</div>
        <div class="metric-value" id="mGSM">0</div>
      </div>
      <div class="metric">
        <div class="metric-label">üé® Unique Styles</div>
        <div class="metric-value" id="mStyles">0</div>
      </div>
      <div class="metric">
        <div class="metric-label">üå± Total CO‚ÇÇ (kg)</div>
        <div class="metric-value" id="mCO2">0</div>
      </div>
    </div>

    <!-- BULK ORDER GENERATOR -->
    <div class="generator-section">
      <h3>üé≤ Advanced Order Generator</h3>
      
      <div class="generator-grid">
        <div class="field">
          <label>Generate Count</label>
          <select id="genCount">
            <option value="1">1 Order</option>
            <option value="5" selected>5 Orders</option>
            <option value="10">10 Orders</option>
            <option value="25">25 Orders</option>
            <option value="50">50 Orders</option>
          </select>
        </div>
        
        <div class="field">
          <label>Product Type</label>
          <select id="genProductType">
            <option value="random">Random Mix</option>
            <option value="Polo shirt">Polo Shirts Only</option>
            <option value="Slim jeans">Jeans Only</option>
            <option value="T-shirt">T-Shirts Only</option>
            <option value="Hoodie">Hoodies Only</option>
            <option value="Blazer">Blazers Only</option>
          </select>
        </div>
        
        <div class="field">
          <label>Quantity Range</label>
          <select id="genQtyRange">
            <option value="small">Small (100-500)</option>
            <option value="medium" selected>Medium (500-2000)</option>
            <option value="large">Large (2000-5000)</option>
            <option value="mixed">Mixed Sizes</option>
          </select>
        </div>
        
        <div class="field">
          <label>Country Focus</label>
          <select id="genCountry">
            <option value="random">Global Mix</option>
            <option value="europe">Europe Only</option>
            <option value="turkey">Turkey Only</option>
            <option value="asia">Asia Pacific</option>
          </select>
        </div>
      </div>
      
      <div class="generator-actions">
        <button class="btn primary" onclick="generateBulkOrders()">
          üöÄ Generate Orders
        </button>
        <button class="btn danger" onclick="clearAllOrders()">
          üóëÔ∏è Clear All
        </button>
        <label style="margin-left: 20px; display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="autoCalculateCO2" checked> Auto-calculate CO‚ÇÇ
        </label>
      </div>
    </div>

    <!-- Add Record Form -->
    <div class="form-section" id="addForm" style="display:none">
      <h3>Add New Production Order</h3>
      <div class="grid">
        <!-- Country -->
        <div class="field">
          <label>Country</label>
          <select id="country">
            <option value="T√ºrkiye">T√ºrkiye</option>
            <option value="Germany">Germany</option>
            <option value="France">France</option>
            <option value="Italy">Italy</option>
            <option value="Spain">Spain</option>
            <option value="Netherlands">Netherlands</option>
            <option value="Poland">Poland</option>
            <option value="UK">UK</option>
          </select>
        </div>

        <!-- PO -->
        <div class="field">
          <label>PO No.</label>
          <input id="po" type="text" placeholder="e.g., PO-24567">
        </div>

        <!-- Style -->
        <div class="field">
          <label>Style Name</label>
          <input id="style" type="text" placeholder="e.g., AURORA-TSH">
        </div>

        <!-- Product Type -->
        <div class="field">
          <label>Product Type</label>
          <select id="productType">
            <option value="Dress shirt">Dress shirt</option>
            <option value="Polo shirt">Polo shirt</option>
            <option value="T-shirt">T-shirt</option>
            <option value="Hoodie">Hoodie</option>
            <option value="Tank top">Tank top</option>
            <option value="Slim jeans">Slim jeans</option>
            <option value="Regular jeans">Regular jeans</option>
            <option value="Shorts">Shorts</option>
            <option value="Chinos">Chinos</option>
            <option value="Blazer">Blazer</option>
            <option value="Jacket">Jacket</option>
            <option value="Sweatshirt">Sweatshirt</option>
          </select>
        </div>

        <!-- Fabric Type -->
        <div class="field">
          <label>Fabric Type</label>
          <select id="fabricType">
            <option value="Knit">Knit</option>
            <option value="Woven">Woven</option>
            <option value="Denim">Denim</option>
            <option value="Cotton">Cotton</option>
            <option value="Polyester">Polyester</option>
            <option value="Wool">Wool</option>
            <option value="Linen">Linen</option>
            <option value="Silk">Silk</option>
            <option value="Spandex">Spandex</option>
            <option value="Rayon">Rayon</option>
          </select>
        </div>

        <!-- Fabric Name -->
        <div class="field">
          <label>Fabric Name</label>
          <input id="fabricName" type="text" placeholder="e.g., Single Jersey / Twill / Denim">
          <div class="helper">Required</div>
        </div>

        <!-- Fabric Code -->
        <div class="field">
          <label>Fabric Code</label>
          <input id="fabricCode" type="text" placeholder="e.g., SJ-180-KN / DN-420-WV">
          <button class="btn" onclick="generateFabricCode()" style="margin-top:6px;padding:6px 12px;font-size:12px">Generate</button>
          <div class="helper" id="fcHelper">Required ‚Ä¢ Pattern: AAA-123(-XXXX)</div>
        </div>

        <!-- Fabric Construction -->
        <div class="field">
          <label>Fabric Construction</label>
          <select id="fabricConstruction">
            <option value="Single Jersey">Single Jersey</option>
            <option value="Pique Knit">Pique Knit</option>
            <option value="Fleece">Fleece</option>
            <option value="Rib">Rib</option>
            <option value="Interlock">Interlock</option>
            <option value="Twill">Twill</option>
            <option value="Plain Weave">Plain Weave</option>
            <option value="Poplin">Poplin</option>
            <option value="Oxford">Oxford</option>
            <option value="Canvas">Canvas</option>
            <option value="Denim">Denim</option>
            <option value="Chambray">Chambray</option>
          </select>
        </div>

        <!-- Fabric Weight -->
        <div class="field">
          <label>Fabric Weight (gsm)</label>
          <input id="fabricWeight" type="number" min="80" max="600" step="10" placeholder="e.g., 180">
          <div class="helper">80-600 gsm typical range</div>
        </div>

        <!-- Quantity -->
        <div class="field">
          <label>Quantity</label>
          <input id="qty" type="number" min="0" step="1" placeholder="e.g., 1200">
        </div>

        <!-- Production Steps -->
        <div class="field">
          <label>Production Step (multi)</label>
          <div style="position:relative">
            <input id="steps" type="text" placeholder="Select production steps..." readonly onclick="toggleMultiSelect()">
            <div id="stepsDropdown" class="multi-select-dropdown">
              <!-- Populated by JS -->
            </div>
          </div>
          <div class="helper">Tƒ±klayarak istediƒüiniz production step'leri se√ßin.</div>
        </div>

        <!-- NEW: Auto CO2 field -->
        <div class="field">
          <label>CO‚ÇÇ Emission (kg) ‚Äî Auto</label>
          <input id="co2" type="number" placeholder="0.00" readonly>
          <div class="helper" id="co2Helper">Estimated from GSM √ó product area √ó emission factor.</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" onclick="saveRecord()">üíæ Save Record</button>
        <button class="btn" onclick="hideAddForm()">Cancel</button>
      </div>
    </div>

    <!-- Action Buttons -->
    <div style="margin-bottom:24px;display:flex;gap:12px;flex-wrap:wrap">
      <button class="btn primary" onclick="showAddForm()">Add Record</button>
      <button class="btn" onclick="clearForm()">üóëÔ∏è Clear</button>
      <button class="btn" onclick="exportCSV()">üìä Export CSV</button>
      <button class="btn" onclick="importCSV()">üì• Import CSV</button>
      <button class="btn" onclick="downloadTemplate()">‚¨áÔ∏è Download CSV Template</button>
    </div>

    <!-- Data Table -->
    <div class="table-container" id="tableContainer">
      <table class="table">
        <thead>
          <tr>
            <th>Actions</th>
            <th>Country</th>
            <th>PO No.</th>
            <th>Style</th>
            <th>Product Type</th>
            <th>Fabric Type</th>
            <th>Fabric Weight (gsm)</th>
            <th>Quantity</th>
            <th>CO‚ÇÇ (kg)</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Populated by JS -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Popup for Record Details -->
  <div id="recordPopup" class="popup">
    <div class="popup-content">
      <div class="popup-header">
        <h3 id="popupTitle">Record Details</h3>
        <button class="popup-close" onclick="closePopup()">&times;</button>
      </div>
      <div class="popup-body" id="popupBody">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <!-- Hidden file input -->
  <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="handleCSVImport(event)">

  <script>
    // === UTILITIES ===
    const qs = (sel) => document.querySelector(sel);

    // === STATE ===
    const state = {
      rows: [],
      editingId: null,
      dirty: false
    };

    // === FORM REFERENCES ===
    const form = {
      country: qs('#country'),
      po: qs('#po'),
      style: qs('#style'),
      productType: qs('#productType'),
      fabricType: qs('#fabricType'),
      fabricName: qs('#fabricName'),
      fabricCode: qs('#fabricCode'),
      fabricConstruction: qs('#fabricConstruction'),
      fabricWeight: qs('#fabricWeight'),
      qty: qs('#qty'),
      steps: qs('#steps'),
      co2: qs('#co2'),
      co2Helper: qs('#co2Helper')
    };

    // === FABRIC EMISSION FACTORS (kg CO2 / kg fabric) ===
    const FABRIC_EF = {
      'Cotton': 5.9, 'Knit': 4.3, 'Woven': 3.8, 'Denim': 7.2, 'Polyester': 9.5,
      'Wool': 10.4, 'Linen': 1.8, 'Silk': 11.5, 'Spandex': 8.9, 'Rayon': 6.7
    };

    // === FORM HANDLERS ===
    [form.country, form.po, form.style, form.productType, form.fabricType, form.fabricName, form.fabricCode, form.fabricConstruction, form.fabricWeight, form.qty].forEach(el => {
      el.addEventListener('change', () => { if(state.editingId) state.dirty = true; updateCO2(); });
    });

    // === MULTI-SELECT STEPS ===
    const PRODUCTION_STEPS = [
      'Pattern Making', 'Cutting', 'Sewing', 'Embroidery', 'Printing', 'Dyeing', 
      'Washing', 'Pressing', 'Finishing', 'Quality Control', 'Packing', 'Labeling'
    ];

    let selectedSteps = [];

    function populateStepsDropdown() {
      const dropdown = qs('#stepsDropdown');
      dropdown.innerHTML = PRODUCTION_STEPS.map(step => 
        `<div class="multi-select-option" onclick="toggleStep('${step}')">${step}</div>`
      ).join('');
    }

    function toggleMultiSelect() {
      const dropdown = qs('#stepsDropdown');
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }

    function toggleStep(step) {
      if (selectedSteps.includes(step)) {
        selectedSteps = selectedSteps.filter(s => s !== step);
      } else {
        selectedSteps.push(step);
      }
      updateStepsDisplay();
      if(state.editingId) state.dirty = true;
    }

    function updateStepsDisplay() {
      form.fabricCode.value = `${suffix}-${gsm}-${prefix}`;
      form.co2Helper.textContent = 'Estimated from GSM √ó product area √ó emission factor.';
    }

    function clearForm() {
      Object.values(form).forEach(el => {
        if (el && el.value !== undefined) el.value = '';
      });
      selectedSteps = [];
      updateStepsDisplay();
      state.editingId = null;
      state.dirty = false;
    }

    function saveRecord() {
      const data = {
        id: state.editingId || crypto.randomUUID(),
        country: form.country.value,
        po: form.po.value,
        style: form.style.value,
        productType: form.productType.value,
        fabricType: form.fabricType.value,
        fabricName: form.fabricName.value,
        fabricCode: form.fabricCode.value,
        fabricConstruction: form.fabricConstruction.value,
        fabricWeight: parseInt(form.fabricWeight.value) || 0,
        qty: parseInt(form.qty.value) || 0,
        steps: [...selectedSteps],
        co2: parseFloat(form.co2.value) || 0
      };

      if (state.editingId) {
        const idx = state.rows.findIndex(r => r.id === state.editingId);
        if (idx >= 0) state.rows[idx] = data;
      } else {
        state.rows.push(data);
      }

      updateStats();
      renderTable();
      hideAddForm();
      clearForm();
    }

    function showAddForm() {
      qs('#addForm').style.display = 'block';
      populateStepsDropdown();
    }

    function hideAddForm() {
      qs('#addForm').style.display = 'none';
    }

    function editRecord(id) {
      const r = state.rows.find(row => row.id === id);
      if (!r) return;

      state.editingId = id;
      state.dirty = false;

      form.country.value = r.country || '';
      form.po.value = r.po || '';
      form.style.value = r.style || '';
      form.productType.value = r.productType || '';
      form.fabricType.value = r.fabricType || '';
      form.fabricName.value = r.fabricName || '';
      form.fabricCode.value = r.fabricCode || '';
      form.fabricConstruction.value = r.fabricConstruction || '';
      form.fabricWeight.value = r.fabricWeight || '';
      form.qty.value = r.qty || '';
      form.co2.value = (r.co2 ?? 0) ? Number(r.co2).toFixed(2) : '';
      updateCO2();

      selectedSteps = Array.isArray(r.steps) ? [...r.steps] : [];
      updateStepsDisplay();

      showAddForm();
    }

    function deleteRecord(id) {
      if (confirm('Delete this record?')) {
        state.rows = state.rows.filter(r => r.id !== id);
        updateStats();
        renderTable();
      }
    }

    // === STATS & RENDERING ===
    function updateStats() {
      const totalPOs = state.rows.length;
      const totalQty = state.rows.reduce((s, r) => s + (Number(r.qty) || 0), 0);
      const avgGSM = totalPOs ? (state.rows.reduce((s, r) => s + (Number(r.fabricWeight) || 0), 0) / totalPOs) : 0;
      const uniqueStyles = new Set(state.rows.map(r => r.style)).size;
      const totalCO2 = state.rows.reduce((s,r)=> s + (Number(r.co2)||0), 0);

      document.getElementById('mPOs').textContent = totalPOs;
      document.getElementById('mQty').textContent = totalQty.toLocaleString();
      document.getElementById('mGSM').textContent = avgGSM.toFixed(0);
      document.getElementById('mStyles').textContent = uniqueStyles;
      document.getElementById('mCO2').textContent = totalCO2.toFixed(2);
    }

    function renderTable() {
      const tbody = qs('#tableBody');
      tbody.innerHTML = state.rows.map(r => `
        <tr>
          <td>
            <button class="btn" onclick="viewRecord('${r.id}')" style="padding:4px 8px;font-size:12px;margin-right:4px">View</button>
            <button class="btn" onclick="editRecord('${r.id}')" style="padding:4px 8px;font-size:12px;margin-right:4px">Edit</button>
            <button class="btn danger" onclick="deleteRecord('${r.id}')" style="padding:4px 8px;font-size:12px">Delete</button>
          </td>
          <td>${r.country}</td>
          <td>${r.po}</td>
          <td>${r.style}</td>
          <td>${r.productType}</td>
          <td>${r.fabricType}</td>
          <td>${r.fabricWeight}</td>
          <td>${(r.qty || 0).toLocaleString()}</td>
          <td>${(Number(r.co2)||0).toFixed(2)}</td>
        </tr>
      `).join('');
    }

    // === RECORD DETAILS POPUP ===
    function viewRecord(id) {
      const r = state.rows.find(row => row.id === id);
      if (!r) return;

      const kv = (key, value) => `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee"><strong>${key}:</strong><span>${value}</span></div>`;

      qs('#popupTitle').textContent = `${r.style} - ${r.po}`;
      qs('#popupBody').innerHTML = `
        <div style="max-width:500px">
          ${kv('Country', r.country)}
          ${kv('PO No.', r.po)}
          ${kv('Style Name', r.style)}
          ${kv('Product Type', r.productType)}
          ${kv('Fabric Type', r.fabricType)}
          ${kv('Fabric Name', r.fabricName)}
          ${kv('Fabric Code', r.fabricCode)}
          ${kv('Fabric Construction', r.fabricConstruction)}
          ${kv('Fabric Weight (gsm)', r.fabricWeight)}
          ${kv('Quantity', (r.qty || 0).toLocaleString())}
          ${kv('Production Step(s)', (r.steps||[]).join(', '))}
          ${kv('CO‚ÇÇ (total kg)', (Number(r.co2)||0).toFixed(2))}
          ${kv("üå± CO‚ÇÇ per Piece", ((Number(r.co2)||0) / Math.max(r.qty||1,1)).toFixed(2) + " kg")}
        </div>
      `;
      qs('#recordPopup').style.display = 'flex';
    }

    function closePopup() {
      qs('#recordPopup').style.display = 'none';
    }

    // === BULK ORDER GENERATOR ===
    function generateBulkOrders() {
      const count = parseInt(document.getElementById('genCount').value);
      const productType = document.getElementById('genProductType').value;
      const qtyRange = document.getElementById('genQtyRange').value;
      const countryFocus = document.getElementById('genCountry').value;
      const autoCalcCO2 = document.getElementById('autoCalculateCO2').checked;
      
      console.log(`üé≤ Generating ${count} orders...`);
      
      for (let i = 0; i < count; i++) {
        const order = generateRandomOrder(productType, qtyRange, countryFocus, autoCalcCO2);
        addOrderToSystem(order);
      }
      
      updateStats();
      renderTable();
      console.log(`‚úÖ Generated ${count} orders successfully!`);
    }

    function generateRandomOrder(productType, qtyRange, countryFocus, autoCalcCO2) {
      // Country pools
      const countries = {
        random: ['T√ºrkiye', 'Germany', 'France', 'Italy', 'Spain', 'Netherlands', 'Poland', 'UK'],
        europe: ['Germany', 'France', 'Italy', 'Spain', 'Netherlands', 'Poland', 'UK'],
        turkey: ['T√ºrkiye'],
        asia: ['T√ºrkiye', 'Bangladesh', 'Vietnam', 'Thailand', 'India']
      };
      
      // Product data
      const productData = {
        'Polo shirt': { fabrics: ['Knit', 'Cotton'], weights: [180, 220, 250], steps: ['Cutting', 'Sewing', 'Quality Control', 'Packing'] },
        'Slim jeans': { fabrics: ['Denim'], weights: [350, 420, 480], steps: ['Cutting', 'Sewing', 'Washing', 'Finishing', 'Packing'] },
        'T-shirt': { fabrics: ['Cotton', 'Knit'], weights: [160, 180, 200], steps: ['Cutting', 'Sewing', 'Printing', 'Packing'] },
        'Hoodie': { fabrics: ['Cotton', 'Polyester'], weights: [400, 450, 500], steps: ['Cutting', 'Sewing', 'Printing', 'Quality Control', 'Packing'] },
        'Blazer': { fabrics: ['Wool', 'Polyester'], weights: [300, 350, 400], steps: ['Cutting', 'Sewing', 'Pressing', 'Quality Control', 'Packing'] }
      };
      
      // Generate values
      const selectedCountries = countries[countryFocus] || countries.random;
      const country = randomChoice(selectedCountries);
      
      const products = productType === 'random' ? Object.keys(productData) : [productType];
      const selectedProduct = randomChoice(products);
      const productInfo = productData[selectedProduct];
      
      // Quantity based on range
      const qtyRanges = {
        small: [100, 500],
        medium: [500, 2000], 
        large: [2000, 5000],
        mixed: [100, 5000]
      };
      const [minQty, maxQty] = qtyRanges[qtyRange] || qtyRanges.medium;
      
      const order = {
        id: crypto.randomUUID(),
        country: country,
        po: `PO-${randomNumber(10000, 99999)}`,
        style: generateStyleName(),
        productType: selectedProduct,
        fabricType: randomChoice(productInfo.fabrics),
        fabricName: generateFabricName(),
        fabricCode: generateFabricCode(),
        fabricConstruction: randomChoice(productInfo.fabrics),
        fabricWeight: randomChoice(productInfo.weights),
        qty: randomNumber(minQty, maxQty),
        steps: productInfo.steps,
        co2: 0
      };
      
      // Auto-calculate CO‚ÇÇ if enabled
      if (autoCalcCO2) {
        order.co2 = calcCO2TotalKg({
          productType: order.productType,
          fabricType: order.fabricType,
          gsm: order.fabricWeight,
          qty: order.qty
        });
      }
      
      return order;
    }

    // Helper functions
    function randomChoice(array) {
      return array[Math.floor(Math.random() * array.length)];
    }

    function randomNumber(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function generateStyleName() {
      const prefixes = ['NOVA', 'ALTA', 'METRO', 'URBAN', 'CLASSIC', 'ELITE', 'PRIME', 'ROYAL', 'SIGMA', 'APEX'];
      const suffixes = ['PRO', 'TSH', 'JNS', 'HDD', 'BLZ', 'PLO', 'DLX', 'MAX', 'ECO', 'LUX'];
      return `${randomChoice(prefixes)}-${randomChoice(suffixes)}`;
    }

    function generateFabricName() {
      const types = ['Single Jersey', 'Pique Knit', 'Fleece', 'Twill', 'Canvas', 'Poplin', 'Oxford', 'Chambray'];
      return randomChoice(types);
    }

    function generateFabricCode() {
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const code = `${letters[Math.floor(Math.random() * letters.length)]}${letters[Math.floor(Math.random() * letters.length)]}-${randomNumber(100, 999)}-${letters[Math.floor(Math.random() * letters.length)]}${letters[Math.floor(Math.random() * letters.length)]}`;
      return code;
    }

    function addOrderToSystem(order) {
      state.rows.push(order);
    }

    function clearAllOrders() {
      if (confirm('üóëÔ∏è Clear all orders? This cannot be undone.')) {
        state.rows = [];
        state.editingId = null;
        updateStats();
        renderTable();
        console.log('üóëÔ∏è All orders cleared!');
      }
    }

    // Dirty mark on input changes + CO2 auto-update
    document.addEventListener('DOMContentLoaded', () => {
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#steps') && !e.target.closest('#stepsDropdown')) {
          qs('#stepsDropdown').style.display = 'none';
        }
      });

      // Auto-update CO2 on input changes
      const handler = ()=>{ if(state.editingId) state.dirty = true; updateCO2(); };
      [form.productType, form.fabricType, form.fabricWeight, form.qty].forEach(el => {
        el.addEventListener('input', handler);
        el.addEventListener('change', handler);
      });

      // Close popup when clicking outside
      qs('#recordPopup').addEventListener('click', (e) => {
        if (e.target === qs('#recordPopup')) closePopup();
      });

      // Load sample data
      state.rows = [
        {id:crypto.randomUUID(), country:'T√ºrkiye', po:'PO-12001', style:'NOVA-POLO', productType:'Polo shirt', fabricType:'Knit', fabricConstruction:'Pique Knit', fabricWeight:220, qty:1800, steps:['Cutting','Sewing','Quality Control','Packing'], co2:0},
        {id:crypto.randomUUID(), country:'Germany', po:'PO-12002', style:'ALTA-JNS', productType:'Slim jeans', fabricType:'Denim', fabricConstruction:'Denim', fabricWeight:420, qty:950, steps:['Cutting','Sewing','Washing','Finishing','Packing'], co2:0}
      ];

      // Auto-calculate CO2 for sample data
      state.rows.forEach(r => {
        r.co2 = calcCO2TotalKg({productType:r.productType,fabricType:r.fabricType,gsm:r.fabricWeight,qty:r.qty});
      });

      updateStats();
      renderTable();
      updateCO2();

      console.log('üéâ Rabateks Garment DPP loaded successfully!');
    });
  </script>
</body>
</html>steps.value = selectedSteps.join(', ');
      
      // Update visual state
      document.querySelectorAll('.multi-select-option').forEach(el => {
        const step = el.textContent;
        el.classList.toggle('selected', selectedSteps.includes(step));
      });
    }

    // === CO2 ESTIMATOR (BETA) ===
    function getProductArea(productType) {
      const areas = {
        'T-shirt': 0.8, 'Polo shirt': 0.9, 'Dress shirt': 1.0, 'Hoodie': 1.2, 'Tank top': 0.6,
        'Slim jeans': 1.1, 'Regular jeans': 1.2, 'Shorts': 0.7, 'Chinos': 1.0,
        'Blazer': 1.5, 'Jacket': 1.8, 'Sweatshirt': 1.1
      };
      return areas[productType] || 1.0;
    }

    function calcCO2TotalKg({productType, fabricType, gsm, qty}){
      const area = getProductArea(productType || 'T-shirt');
      const massPerPieceKg = (Math.max(gsm||0,0) * area) / 1000; // kg
      const ef = FABRIC_EF[fabricType] ?? 6.0;          // kg CO2 / kg fabric
      const co2PerPiece = massPerPieceKg * ef; // kg CO2
      return co2PerPiece * Math.max(qty||0,0);
    }

    function updateCO2(){
      const productType = form.productType.value;
      const fabricType = form.fabricType.value;
      const gsm = parseFloat(form.fabricWeight.value) || 0;
      const qty = parseInt(form.qty.value) || 0;
      const total = calcCO2TotalKg({productType, fabricType, gsm, qty});
      form.co2.value = total ? total.toFixed(2) : '';
      
      const area = getProductArea(productType || 'T-shirt');
      const ef = FABRIC_EF[fabricType] ?? 6.0;
      const co2PerPiece = ((gsm * area)/1000) * ef;
      form.co2Helper.textContent = `Estimated: ${co2PerPiece.toFixed(3)} kg CO‚ÇÇ / piece √ó ${qty || 0} pcs = ${total.toFixed(2)} kg.`;
    }

    // === CSV FUNCTIONALITY ===
    const CSV_HEADERS = ["id","country","po","style","productType","fabricType","fabricName","fabricCode","fabricConstruction","fabricWeight","qty","steps","co2"];

    function exportCSV() {
      if (!state.rows.length) return alert('No data to export');
      
      const rows = state.rows.map(r => {
        const steps = Array.isArray(r.steps) ? r.steps.join(';') : String(r.steps || '');
        const vals = [ r.id, r.country, r.po, r.style, r.productType, r.fabricType, r.fabricName, r.fabricCode, r.fabricConstruction, r.fabricWeight, r.qty, steps, r.co2 ?? 0 ];
        return vals.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',');
      });
      
      const csv = [CSV_HEADERS.join(','), ...rows].join('\n');
      downloadFile(csv, 'garment-dpp-data.csv', 'text/csv');
    }

    function downloadTemplate() {
      const template = CSV_HEADERS.join(',') + '\n' + [
        '"","T√ºrkiye","PO-12345","SAMPLE-TSH","T-shirt","Cotton","Single Jersey","SJ-180-CT","Single Jersey","180","1000","Cutting;Sewing;Packing","0"'
      ].join('\n');
      downloadFile(template, 'garment-dpp-template.csv', 'text/csv');
    }

    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importCSV() {
      qs('#csvInput').click();
    }

    function handleCSVImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const csv = e.target.result;
          const lines = csv.split('\n').filter(l => l.trim());
          const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
          
          lines.slice(1).forEach(line => {
            const values = line.split(',').map(v => v.replace(/"/g, '').trim());
            const obj = {};
            headers.forEach((h, i) => obj[h] = values[i] || '');
            
            obj.id = obj.id || crypto.randomUUID();
            obj.fabricWeight = parseInt(obj.fabricWeight) || 180;
            obj.qty = parseInt(obj.qty) || 0;
            obj.co2 = parseFloat(obj.co2) || 0;
            obj.steps = (obj.steps || '').split(';').filter(s => s.trim());
            
            state.rows.push(obj);
          });
          
          updateStats();
          renderTable();
          alert(`Imported ${lines.length - 1} records`);
        } catch (err) {
          alert('Import failed: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    // === FORM ACTIONS ===
    function generateFabricCode() {
      const fabricType = form.fabricType.value;
      const gsm = form.fabricWeight.value || '180';
      
      const prefixes = { 'Cotton': 'CT', 'Knit': 'KN', 'Woven': 'WV', 'Denim': 'DN', 'Polyester': 'PL', 'Wool': 'WL', 'Linen': 'LN', 'Silk': 'SK', 'Spandex': 'SP', 'Rayon': 'RY' };
      const prefix = prefixes[fabricType] || 'XX';
      const suffix = Math.random().toString(36).substr(2, 2).toUpperCase();
      
      form.